@using WebMatrix.Data;
<h2>تقرير رصيد الأجازات</h2>
<h1 class="alert alert-warning" role="alert">تنبيه! هذا الرصيد غير رسمي ولا يتم الاخذ به </h1>

<!--div class="input-group" dir="rtl">
    <button class="btn btn-success " id="excel">EXCEL</button>
</div-->
<hr>
<div id="loader" style="position: absolute;
                        width: 100%;
                        z-index: 100;
                        height: 0;
                        background-color: #FFF;">
        <img src="~/3.gif" style="margin:auto; ">
</div>
<div id="container" style="overflow-x:auto">
    <table dir="rtl" id="example" class="display" style="width:100%"></table>
</div>
<div id="dialog-form">

</div>
<script>
    $.ajax({
        url:"/DeferredVacations/ListAll",
        success: function (data) {
            $("#loader").hide();
       var columns = [
      {data: 'fileNumber', title: 'رقم الملف'}
     ,{data: 'name', title: 'الاسم',}
     ,{data: 'departmentId', title: 'القسم', }
     ,{data: 'deferredDate', title: 'تاريخ التعديل',render:function(k,i){return k.substr(0,10);}}
     ,{data: 'deferredDays', title: 'رصيد افتتاحي', }
     ,{data: 'abcenceDays', title: 'مجموع الأجازات',}
     ,{data: 'availableDays', title: 'رصيد الاجازات',render:function(k,i){return '<b>'+k+'</b>';}}
     ,{"defaultContent": "<button id='del-btn' class='btn btn-success'>show</button>"}
            ];
            //console.log(columns);
            console.log(data);
            var tb = $('#example').dataTable({
                stateSave: true,
                "destroy": true,
                "data": data.filter(w =>EMPS.includes(''+w.fileNumber)),
                "columns": columns
            });
             $('#example tbody').on('click', "#del-btn", function() {
              let mainData=
              {
                  fileNo:$(this).closest('tr').find("td").eq(0).html(),
                  name:$(this).closest('tr').find("td").eq(1).html(),
                  OB:$(this).closest('tr').find("td").eq(4).html(),
                  OBdate:$(this).closest('tr').find("td").eq(3).html(),
                  balance:$(this).closest('tr').find("td").eq(6).text()
              }
            console.log(mainData);
            readVacs(mainData);
            dialog.dialog( "open" );
        });
        },failed:(e)=>{
             $("#loader").hide();
        }
        });
</script>
<script src="~/scripts/excelexportjs.js"></script>
<script>
    $(function () {
         $('#excel').click(function () {
             $.ajax(
            {
                type: 'POST',
                dataType: 'JSON',
                url: '/DeferredVacations/ListAll',
                success:
                    function (response) {
                        $("table").excelexportjs({
                            datatype: 'json'
                           , dataset: response
                           , columns: getColumns(response)
                        });
                    },
                error:
                    function (response) {
                        alert("Error: " + response);
                    }
            });
         });       
 });

 function readVacs(mainData)
{
var  sql0=

`
declare @@f date ;
set @@f='${mainData.OBdate}'
;with month_cte as
( 
select @@f dateDay
union All
select dateadd(day,1,dateDay)
from month_cte
where dateDay<=getdate()
)
select dateDay,isnull(DayPart,0) DayPart ,case when DATEPART(day, dateDay)=26 then 1.75 else 0 end 'addition' from month_cte c left join
(
select DateFrom,sum(DayPart)DayPart from Absences where
    DateFrom>=@@f
and AbsenceTypeId in(3,7) and 
    EmployeeId =(select id  from Employees where FileNumber='${mainData.fileNo}')
group by DateFrom
)q
on q.DateFrom=c.dateDay
where DayPart is not null or DATEPART(day, dateDay)=26
order by dateDay asc 
option (maxrecursion 0)
`;
console.log(mainData)
var data=readSQL(sql0)
console.log(data)
var balance=mainData.OB
if(data.length==0)
	{
       
	}
    else
    {
        var html='<table border=1 dir="rtl" class="table table-bordered"><tr><th>التاريخ</th><th>الاجازة</th><th>اضافة رصيد</th><th>الرصيد</th></tr>';
            html+='<tr><th style="background-color:yellow">'+ mainData.OBdate+
                      '</th><th style="background-color:skyblue" colspan=2 >'+ "رصيد افتتاحي "+
                      '</th><th style="background-color:#11cc33">'+ balance +'</th></tr>';
            for(var i=0; i<data.length;i++)
            {
                balance=parseFloat(balance)+(parseFloat((i==0 && data[i].dateDay.substr(0,10)==mainData.OBdate)?0:data[i].addition))-parseFloat(data[i].DayPart);
                html+='<tr><th style="background-color:#159754">'+ data[i].dateDay.substr(0,10) +
                      '</th><th style="background-color:#aabb00">'+ data[i].DayPart +
                      '</th><th style="background-color:#15aF44">'+ ((i==0 && data[i].dateDay.substr(0,10)==mainData.OBdate)?0:data[i].addition) +
                      '</th><th style="background-color:#11cc33">'+ balance +'</th></tr>';
            }
            
            html+='</table>';
       $("#dialog-form").html(html);


    }
}
var dialog = $( "#dialog-form" ).dialog({
      autoOpen: false,
      height: 800,
      width: 500,
      modal: true,
      buttons: {
        Cancel: function() {
          dialog.dialog( "close" );
        }
      }
    });
 </script>