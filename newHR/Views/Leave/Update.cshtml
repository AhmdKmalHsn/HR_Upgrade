<h2>تعديل انصراف</h2>
<div id="percent" style="display:flex;flex-direction: column;border:1px solid black">
    <!--div style="height:20px;left:0-45%;width:10%;position:relative;background-color:green">
</div-->
</div>
<div class="card">
    <div class="row">
        <div class="col-2"><label class="form-label">id</label></div>
        <div class="col-4">
            <div id="Id"></div>
        </div>
        <div class="col-3"><label class="form-label">Warning From</label></div>
        <div class="col-3"><input id="Warning_From" type="time" class="form-control" /></div>
    </div>
    <div class="row">
        <div class="col-2"><label class="form-label">shift id</label></div>
        <div class="col-4">
            <div id="ShiftId"></div>
        </div>
        <div class="col-3"><label class="form-label">Warning_To</label></div>
        <div class="col-3"><input id="Warning_To" type="time" class="form-control" /></div>
    </div>
    <div class="row">
        <div class="col-2"><label class="form-label">shift name</label></div>
        <div class="col-4">
            <div id="ShiftName"></div>
        </div>
        <div class="col-3"><label class="form-label">Allowed_Delay</label></div>
        <div class="col-3"><input id="Allowed_Delay" type="time" class="form-control" /></div>
    </div>
</div>

<button id="leaveAdd" class="btn btn-outline-success">إضافة</button>
<br>
<table id="myTable" class="display" style="width:95%"></table>

<div id="AddForm" dir="rtl" title="Create new Leave">
    <div class="row p-2">
        <div class="col-2">
            <div class="col-form-label">من</div>
        </div>
        <div class="col-4">
            <input type="time" class="form-control" id="timeFrom" />
        </div>
        <div class="col-2">
            <div class="col-form-label">حتي</div>
        </div>
        <div class="col-4">
            <input type="time" class="form-control" id="timeTo" />
        </div>
    </div>
    <div class="row p-2">
        <div class="col-2">
            <div class="col-form-label">القيمة</div>
        </div>
        <div class="col-4">
            <div class="input-group">
                <input type="number" class="form-control" id="timeValue1" />:<input type="number" class="form-control"
                    id="timeValue2" />
            </div>
        </div>

        <div class="col-2">
            <div class="col-form-label">قيمة الغياب من اليوم</div>
        </div>
        <div class="col-4">
            <div class="input-group">
                <select class="form-control" id="dayPart">
                    <option value=0>0</option>
                    <option value=0.25>0.25</option>
                    <option value=0.5>0.5</option>
                    <option value=1>1</option>
                </select>
            </div>
        </div>
    </div>
    <hr>
    <div class="row p-2">
        <div class="col-2">
            <input value="تأكيد" class="btn btn-outline-warning" type="button" id="timeSubmit">
        </div>
    </div>
</div>
<!---->
<div id="EdtForm" dir="rtl" title="Edit a Leave" class="EdtClass">
    <div class="row p-2">
        <div class="col-2">
            <div class="col-form-label">من</div>
        </div>
        <div class="col-4">
            <input type="time" class="form-control" id="timeFrom" />
        </div>
        <div class="col-2">
            <div class="col-form-label">حتي</div>
        </div>
        <div class="col-4">
            <input type="time" class="form-control" id="timeTo" />
        </div>
    </div>
    <div class="row p-2">
        <div class="col-2">
            <div class="col-form-label">القيمة</div>
        </div>
        <div class="col-4">
            <div class="input-group">
                <input type="number" class="form-control" id="timeValue1" />:<input type="number" class="form-control"
                    id="timeValue2" />
            </div>
        </div>

        <div class="col-2">
            <div class="col-form-label">قيمة الغياب من اليوم</div>
        </div>
        <div class="col-4">
            <div class="input-group">
                <select class="form-control" id="dayPart">
                    <option value=0>0</option>
                    <option value=0.25>0.25</option>
                    <option value=0.5>0.5</option>
                    <option value=1>1</option>
                </select>
            </div>
        </div>
    </div>
    <hr>
    <div class="row p-2">
        <div class="col-2">
            <input value="تأكيد" class="btn btn-outline-warning" type="button" id="changesSave">
        </div>
    </div>
</div>

<!--input value="حفظ التغييرات" class="btn btn-outline-warning" type="button" id="changesSave"-->

<script>
    var q = window.location.href;
    var url = new URL(q);
    var id = url.searchParams.get("id");
    var sql1 = `select Id,ShiftId,ShiftName,Warning_From,Warning_To,Allowed_Delay from Delays where id=${id}`;
    var sql2 = `select Id,[From],[To],Value,DelayId,DayPart from LeaveFromToes where DelayId =${id} order by [from]`;
    var data1 = readSQL(sql1);
    var data2;

    $("#Id").html(data1[0].Id)
    $("#ShiftId").html(data1[0].ShiftId)
    $("#ShiftName").html(data1[0].ShiftName)
    $("#Warning_From").val(data1[0].Warning_From)
    $("#Warning_To").val(data1[0].Warning_To)
    $("#Allowed_Delay").val(data1[0].Allowed_Delay)
    
    var table;
    function init() {
        data2 = readSQL(sql2);
        draw();
        table = $("#myTable").dataTable(
            {
                "iDisplayLength": 50,
                data: readSQL(sql2),
                columns: [

                    {
                        title: "From",
                        data: "From",
                    },
                    {
                        title: "To",
                        data: "To",
                    },
                    {
                        title: "Value",
                        data: "Value",
                    },
                    {
                        title: "DayPart",
                        data: "DayPart",
                    },
                    {
                        title: "",
                        data: "Id",
                        render: function (e) {
                            return '<button onclick="Edt(' + e + ')" class="btn btn-outline-info">Edit</button>&#160;<button onclick="del(' + e + ')" class="btn btn-outline-danger">Delete</button>'
                        }
                    },
                ]
            });
    }

    function del(id) {
        var res = excuteSQL(`delete from LeaveFromToes where Id =${id}`);
        if (res == 1) {
            alert("Delete Successfully!")
            table.fnDestroy();
            $('#myTable').empty();
            init();
        }
        else alert("Error")
    }
    let temp;
    function Edt(id) {
         //console.log("id =>" + id);
        temp=data2.filter(w => w.Id == id)
        $("#EdtForm #timeFrom").val(temp[0].From)
        $("#EdtForm #timeTo").val(temp[0].To)
        $("#EdtForm #timeValue1").val(temp[0].Value.split(":")[1])
        $("#EdtForm #timeValue2").val(temp[0].Value.split(":")[0])
        $("#EdtForm #dayPart").val(temp[0].DayPart)

        //console.log($(temp[0]))
        dialog2.dialog("open");
        
    }

    var dialog = $('#AddForm').dialog(
        {
            autoOpen: false,
            height: 300,
            width: 550,
            modal: true,
        });
    var dialog2 = $('#EdtForm').dialog(
        {
            autoOpen: false,
            height: 300,
            width: 550,
            modal: true,
        });
    init();
    $("#leaveAdd").click(function () {
        dialog.dialog("open");
    });


    $("#timeSubmit").click(function () {
        var sql = `insert  into LeaveFromToes([From],[To],Value,DelayId,daypart )values('${$("#timeFrom").val()}','${$("#timeTo").val()}','${$("#timeValue2").val()}:${$("#timeValue1").val()}',${id},${$("#dayPart").val()})`
        //console.log(sql);
        if (excuteSQL(sql) == 1) {
            alert("Insert Successfully!")
            dialog.dialog("close");
            table.fnDestroy();
            $('#myTable').empty();
            init();
        }
        else alert("Error")
    });


    $("#changesSave").click(function () {
        let sql=`update leaveFromToes set [From]='${$("#EdtForm #timeFrom").val()}',[To]='${$("#EdtForm #timeTo").val()}',Value='${$("#EdtForm #timeValue2").val()}:${$("#EdtForm #timeValue1").val()}',DayPart=${$("#EdtForm #dayPart").val()} where Id=${temp[0]["Id"]}`
        //console.log(sql);
        var res = excuteSQL(sql);
        if (res == 1){
            alert("Update Successfully!");
            dialog2.dialog("close");
            table.fnDestroy();
            $('#myTable').empty();
            init();
        } 
        else alert("Error")
    });
    function draw() {
        let htmlpercent = ''
        let xoffset = 45;
        //console.log(data2)
        data2.forEach((e) => {
            let f = (parseInt(e.From.split(":")[0]) * 60 + parseInt(e.From.split(":")[1])) / 14.40;
            let t = (parseInt(e.To.split(":")[0]) * 60 + parseInt(e.To.split(":")[1]) + 1) / 14.40;
            let v = (parseInt(e.Value.split(":")[0]) * 60 + parseInt(e.Value.split(":")[1]));
            let d = e.DayPart;
            let color = '';
            switch (true) {
                case d == 1: color = 'red'; break;
                case v == 0: color = 'green'; break;
                default: color = 'yellow';
            }
            //console.log(`f=${f - xoffset},t=${t},${t - f} v=${v} d=${d}`)

            htmlpercent += `<div style="height:20px;left:${f}%;width:${t - f}%;position:relative;background-color:${color}"></div>`
        })
        $("#percent").html(htmlpercent);
    }
</script>